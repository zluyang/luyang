<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="HEVC,H.265,HEIF,WWDC,2017,ç¼–ç åŸç†," />










<meta name="description" content="å‰æƒ…æè¦ä»€ä¹ˆæ˜¯HEVCã€è‹¹æœä¸ºä»€ä¹ˆé€‰æ‹©HEVCï¼Œä¹‹å‰åœ¨503 hevc introduceå·²ç»ä»‹ç»è¿‡äº†ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯ä¸ºäº†4Kç”šè‡³æ›´å¤§çš„åˆ†è¾¨ç‡ã€é«˜æ¯”ç‰¹æ·±åº¦ï¼ˆhigh depthsï¼‰æ¯”å¦‚10-bitã€æ›´å®½çš„è‰²å½©ç©ºé—´ï¼Œåšè¿™äº›éƒ½éœ€è¦æ›´é«˜çš„å‹ç¼©ç‡æ¥æ”¯æ’‘ï¼Œhevcç›¸å¯¹H.264å‹ç¼©ç‡æé«˜äº†40%ï¼Œå¯¹äºç›¸æœºé‡‡é›†çš„åœºæ™¯ï¼Œç›¸æ¯”H.264å‹ç¼©ç‡æå‡äº†50%  ä»Šå¤©è®²çš„ä¸»è¦æ˜¯å¦‚ä½•åº”ç”¨ï¼Œåˆ†å››ä¸ªä¸»é¢˜ï¼š  Access Pl">
<meta name="keywords" content="HEVC,H.265,HEIF,WWDC,2017,ç¼–ç åŸç†">
<meta property="og:type" content="article">
<meta property="og:title" content="WWDC 2017 Session 511 Working with HEIF and HEVC">
<meta property="og:url" content="https://zluyang.github.io/luyang/2017/08/27/wwdc-2017-Session-511-Working-withHEIF-and-HEVC/index.html">
<meta property="og:site_name" content="è°·é›¨">
<meta property="og:description" content="å‰æƒ…æè¦ä»€ä¹ˆæ˜¯HEVCã€è‹¹æœä¸ºä»€ä¹ˆé€‰æ‹©HEVCï¼Œä¹‹å‰åœ¨503 hevc introduceå·²ç»ä»‹ç»è¿‡äº†ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯ä¸ºäº†4Kç”šè‡³æ›´å¤§çš„åˆ†è¾¨ç‡ã€é«˜æ¯”ç‰¹æ·±åº¦ï¼ˆhigh depthsï¼‰æ¯”å¦‚10-bitã€æ›´å®½çš„è‰²å½©ç©ºé—´ï¼Œåšè¿™äº›éƒ½éœ€è¦æ›´é«˜çš„å‹ç¼©ç‡æ¥æ”¯æ’‘ï¼Œhevcç›¸å¯¹H.264å‹ç¼©ç‡æé«˜äº†40%ï¼Œå¯¹äºç›¸æœºé‡‡é›†çš„åœºæ™¯ï¼Œç›¸æ¯”H.264å‹ç¼©ç‡æå‡äº†50%  ä»Šå¤©è®²çš„ä¸»è¦æ˜¯å¦‚ä½•åº”ç”¨ï¼Œåˆ†å››ä¸ªä¸»é¢˜ï¼š  Access Pl">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/choose_codec.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/capturemoviewithhevc.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/captureLivePhoto.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/captureComplate.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/VideoToolBoxPreset.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/bitdepth.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame101.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame1.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame2.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame3.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame4.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame6.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame7.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame8.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/frame9.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/heifpronounce.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/heifdepthmap.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/zhihuceju.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/origingirl.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/origingirl1.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/origingirl2.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/origingirl3.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/orgingirlfoot1.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/orgingirlfoot2.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/longExpose.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/zoom1.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/zoom2.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/captureheif.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/capturedelegate.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/oldwaysave.jpg">
<meta property="og:image" content="http://ovbu9b92e.bkt.clouddn.com/newwaysave.jpg">
<meta property="og:updated_time" content="2018-04-30T13:18:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WWDC 2017 Session 511 Working with HEIF and HEVC">
<meta name="twitter:description" content="å‰æƒ…æè¦ä»€ä¹ˆæ˜¯HEVCã€è‹¹æœä¸ºä»€ä¹ˆé€‰æ‹©HEVCï¼Œä¹‹å‰åœ¨503 hevc introduceå·²ç»ä»‹ç»è¿‡äº†ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯ä¸ºäº†4Kç”šè‡³æ›´å¤§çš„åˆ†è¾¨ç‡ã€é«˜æ¯”ç‰¹æ·±åº¦ï¼ˆhigh depthsï¼‰æ¯”å¦‚10-bitã€æ›´å®½çš„è‰²å½©ç©ºé—´ï¼Œåšè¿™äº›éƒ½éœ€è¦æ›´é«˜çš„å‹ç¼©ç‡æ¥æ”¯æ’‘ï¼Œhevcç›¸å¯¹H.264å‹ç¼©ç‡æé«˜äº†40%ï¼Œå¯¹äºç›¸æœºé‡‡é›†çš„åœºæ™¯ï¼Œç›¸æ¯”H.264å‹ç¼©ç‡æå‡äº†50%  ä»Šå¤©è®²çš„ä¸»è¦æ˜¯å¦‚ä½•åº”ç”¨ï¼Œåˆ†å››ä¸ªä¸»é¢˜ï¼š  Access Pl">
<meta name="twitter:image" content="http://ovbu9b92e.bkt.clouddn.com/choose_codec.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zluyang.github.io/luyang/2017/08/27/wwdc-2017-Session-511-Working-withHEIF-and-HEVC/"/>





  <title>WWDC 2017 Session 511 Working with HEIF and HEVC | è°·é›¨</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">è°·é›¨</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">â€œLive well, Laugh often, Love much.â€</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zluyang.github.io/luyang/2017/08/27/wwdc-2017-Session-511-Working-withHEIF-and-HEVC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="è°·é›¨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/avatar/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è°·é›¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">WWDC 2017 Session 511 Working with HEIF and HEVC</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-08-27T20:08:43+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/éŸ³è§†é¢‘/" itemprop="url" rel="index">
                    <span itemprop="name">éŸ³è§†é¢‘</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h1><p>ä»€ä¹ˆæ˜¯HEVCã€è‹¹æœä¸ºä»€ä¹ˆé€‰æ‹©HEVCï¼Œä¹‹å‰åœ¨503 hevc introduceå·²ç»ä»‹ç»è¿‡äº†ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯ä¸ºäº†4Kç”šè‡³æ›´å¤§çš„åˆ†è¾¨ç‡ã€é«˜æ¯”ç‰¹æ·±åº¦ï¼ˆhigh depthsï¼‰æ¯”å¦‚10-bitã€æ›´å®½çš„è‰²å½©ç©ºé—´ï¼Œåšè¿™äº›éƒ½éœ€è¦æ›´é«˜çš„å‹ç¼©ç‡æ¥æ”¯æ’‘ï¼Œhevcç›¸å¯¹H.264å‹ç¼©ç‡æé«˜äº†40%ï¼Œå¯¹äºç›¸æœºé‡‡é›†çš„åœºæ™¯ï¼Œç›¸æ¯”H.264å‹ç¼©ç‡æå‡äº†50%</p>
<p> ä»Šå¤©è®²çš„ä¸»è¦æ˜¯å¦‚ä½•åº”ç”¨ï¼Œåˆ†å››ä¸ªä¸»é¢˜ï¼š</p>
<ul>
<li>Access</li>
<li>Playback</li>
<li>Capture</li>
<li>Export</li>
</ul>
<a id="more"></a>
<h1 id="Access"><a href="#Access" class="headerlink" title="Access"></a>Access</h1><p>PhotoKitçš„PHImageManagerè¯·æ±‚HEVCå†…å®¹æ’­æ”¾</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PHImageManager</span></div><div class="line">manager.requestPlayerItem(forVideo: asset, options: <span class="literal">nil</span>)&#123;(playerItem, dictionary) <span class="keyword">in</span> <span class="comment">// use AVPlayerItem</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">manager.requestLivePhoto(<span class="keyword">for</span>: asset, targetSize: size, contentMode: .<span class="keyword">default</span>, options: <span class="literal">nil</span>)&#123;(livePhoto, dictionary) <span class="keyword">in</span> <span class="comment">// use PHLivePhoto</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PHAssetResourceManagerè¯·æ±‚HEVCçš„Assetsï¼Œå¯è®¿é—®å¯¹åº”æ–‡ä»¶ï¼Œè¿›è¡Œè½¬ç </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PHImageManager</span></div><div class="line">manager.requestExportSession(forVideo: asset, options: <span class="literal">nil</span>, exportPreset: preset)&#123;(session, dictionary) <span class="keyword">in</span> <span class="comment">// use AVAssetExportSession</span></div><div class="line">&#125;</div><div class="line">manager.requestAVAsset(forVideo: asset, options: <span class="literal">nil</span>)&#123;(asset, audioMix, dictionary) <span class="keyword">in</span> <span class="comment">// use AVAsset</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”¨PHAssetResourceManagerè®¿é—®HEVCæ•°æ®</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PHAssetResourceManager</span></div><div class="line">resourceManager.requestData(<span class="keyword">for</span>: assetResource, options: <span class="literal">nil</span>, dataReceivedHandler:&#123;(data) <span class="keyword">in</span> <span class="comment">// use Data</span></div><div class="line">&#125;,&#123;(error) <span class="keyword">in</span> <span class="comment">// handle Error</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h1 id="Playback"><a href="#Playback" class="headerlink" title="Playback"></a>Playback</h1><ol>
<li>HEVCæ”¯æŒAVKitã€AVFoundationã€VideoToolBox</li>
<li>HEVCæ”¯æŒHLSã€æ”¯æŒè¾¹ä¸‹è¾¹æ’­ã€æœ¬åœ°æ–‡ä»¶æ’­æ”¾</li>
<li>MP4,MOVå®¹å™¨æ ¼å¼æ”¯æŒ</li>
<li>APIæ˜¯é€‚é…å¥½çš„ï¼Œä¸ç”¨ä¿®æ”¹è°ƒç”¨ç‚¹</li>
</ol>
<p>æ’­æ”¾ä¸€ä¸ªVideoçš„APIå¯¹äºH.264å’ŒHEVCæ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> player = <span class="type">AVPlayer</span>(url: <span class="type">URL</span>(fileURLWithPath: <span class="string">"MyAwesomeMovie.mov"</span>))    </div><div class="line">player.play()</div></pre></td></tr></table></figure>
<p>å¯¹äºè§£ç èƒ½åŠ›ï¼Œæƒ³è¦åˆ¤æ–­iOSç³»ç»Ÿæ˜¯å¦æ”¯æŒè§£ç ä¸€ä¸ªassetTrackç”¨è¿™isDecodableå±æ€§</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">assetTrack.isDecodable</div></pre></td></tr></table></figure>
<p>å¯¹äºæ’­æ”¾èƒ½åŠ›ï¼Œç”¨isPlayableå±æ€§ï¼Œä¸æ˜¯æ‰€æœ‰å†…å®¹éƒ½èƒ½å®æ—¶æ’­æ”¾ã€ä¸åŒè®¾å¤‡èƒ½åŠ›ä¸ä¸€æ ·<br>ç¡¬è§£ç å¯ä»¥å¾—åˆ°è¾ƒå¥½çš„åŠŸè€—ã€æœ€å¥½çš„è§£ç æ€§èƒ½ï¼Œä¸‹é¢è¿™å¥ç”¨äºåˆ¤æ–­æ˜¯å¦å…·å¤‡ç¡¬è§£èƒ½åŠ›ï¼Œè¿™ä¸ªAPIä¸å…‰å¯ä»¥ç”¨äºåˆ¤æ–­HEVCï¼Œå¯¹äºå…¶ä»–Codecä¹Ÿé€‚ç”¨</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> hardwareDecodeSupported = <span class="type">VTIsHardwareDecodeSupported</span>(kCMVideoCodecType_HEVC)</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¯¥å¦‚ä½•é€‰æ‹©Codecï¼ŒH.264è¿˜æ˜¯HEVCï¼Ÿå¦‚æœä½ æ›´é‡è§†å…¨å¹³å°å…¼å®¹æ€§ï¼Œé€‰H.264,è¿™ä¸œè¥¿æœ‰åå¹´äº†ï¼Œè¢«äº§ä¸šå¹¿æ³›æ¥å—ï¼Œç¬¬ä¸‰æ–¹åº“å¯¹ä»–çš„å…¼å®¹æ€§å¾ˆå¥½ï¼Œå¦‚æœä½ è¦æ›´å°çš„æ–‡ä»¶æˆ–æ›´é«˜çš„æ¸…æ™°åº¦ï¼Œé€‰HEVC<br><img src="http://ovbu9b92e.bkt.clouddn.com/choose_codec.jpg" alt=""></p>
<h1 id="Capture"><a href="#Capture" class="headerlink" title="Capture"></a>Capture</h1><p>æ¥ä¸‹æ¥çœ‹çœ‹Captureï¼Œæˆ‘ä»¬å¯ä»¥ç”¨AVFoundationæ¥é‡‡é›†HEVCè§†é¢‘ï¼Œè§†é¢‘å®¹å™¨æ ¼å¼æ”¯æŒmp4,movï¼Œæœ€ä½é…éœ€è¦A10 CPUä¹Ÿå°±æ˜¯iPhone 7<br>æˆ‘ä»¬çœ‹çœ‹å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ç»“æ„å›¾</p>
<p><img src="http://ovbu9b92e.bkt.clouddn.com/capturemoviewithhevc.jpg" alt=""></p>
<p>è¿™ä¸ªå›¾ä¸å†èµ˜è¿°ï¼Œå½•åˆ¶H.264 4Kè§†é¢‘çš„å¸¸è§„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> session = <span class="type">AVCaptureSession</span>()   </div><div class="line">session.sessionPreset = .hd4K3840x2160</div><div class="line"><span class="keyword">let</span> camera = <span class="type">AVCaptureDevice</span>.<span class="keyword">default</span>(.builtInWideAngleCamera, <span class="keyword">for</span>: <span class="literal">nil</span>, position: .back)   </div><div class="line"><span class="keyword">let</span> input = <span class="keyword">try</span>! <span class="type">AVCaptureDeviceInput</span>(device: camera!)</div><div class="line">session.addInput(input)</div><div class="line"><span class="keyword">let</span> movieFileOutput = <span class="type">AVCaptureMovieFileOutput</span>()    </div><div class="line">session.addOutput(movieFileOutput)</div><div class="line">session.startRunning()</div><div class="line">movieFileOutput.startRecording(to: url, recordingDelegate: <span class="keyword">self</span>)</div></pre></td></tr></table></figure>
<p>å½•åˆ¶HEVCæ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> connection = movieFileOutput.connection(with: .video)</div><div class="line"><span class="keyword">if</span> movieFileOutput.availableVideoCodecTypes.<span class="built_in">contains</span>(.hevc) &#123;</div><div class="line">    outputSetings = [<span class="type">AVVideoCodecKey</span>: <span class="type">AVVideoCodecType</span>.hevc]</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">    outputSetings = [<span class="type">AVVideoCodecKey</span>: <span class="type">AVVideoCodecType</span>.h264] </div><div class="line">&#125;</div><div class="line">movieFileOutput.setOutputSettings(outputSetings, <span class="keyword">for</span>: connection!)</div></pre></td></tr></table></figure>
<p>é‡‡é›†HEVCçš„LivePhotoï¼Œç»“æ„ä¸è§†é¢‘ç±»ä¼¼ï¼Œä½†Outputæ¢æˆäº†AVCapturePhotoOutput<br><img src="http://ovbu9b92e.bkt.clouddn.com/captureLivePhoto.jpg" alt=""></p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹LivePhotoæœ‰å“ªäº›æ›´æ–°ï¼š</p>
<ul>
<li>è§†é¢‘ç¨³å®šæ€§ï¼Œæ’­æ”¾æ—¶ç”»é¢ä¸å†é¢¤æŠ–</li>
<li>åœ¨æ’­æ”¾LivePhotoæ—¶å€™ä¸å†åœæ‰éŸ³ä¹æ’­æ”¾</li>
<li>æ›´åŠ æµç•…ï¼Œå¸§ç‡æ”¯æŒ30fps</li>
</ul>
<p>å½•åˆ¶HEVCçš„LivePhoto<br>iOS11æä¾›äº†æ–°APIåˆ¤æ–­æ˜¯å¦æ”¯æŒæŸä¸ªcodecï¼Œå¦‚æœä¸åšè¿™ä¸ªåˆ¤æ–­èµ‹å€¼ï¼Œé»˜è®¤æ˜¯.hevc</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> photoSettings = <span class="type">AVCapturePhotoSettings</span>() </div><div class="line">photoSettings.livePhotoMovieFileURL = <span class="type">URL</span>(fileURLWithPath: myFilePath)</div><div class="line"><span class="keyword">if</span> photoOutput.availableLivePhotoVideoCodecTypes.<span class="built_in">contains</span>(.hevc) &#123;</div><div class="line">    photoSettings.livePhotoVideoCodecType = .hevc</div><div class="line">&#125;</div><div class="line">photoOutput.capturePhoto(with: photoSettings, delegate: <span class="keyword">self</span>)</div></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯å®šåˆ¶æ€§è¾ƒå¼ºçš„é‡‡é›†æµç¨‹å›¾ï¼Œç”¨åˆ°äº†AVAssetWriterï¼Œå¯ä»¥æƒ³åŠ ä¸€å±‚æ»¤é•œå¤„ç†ã€‚<br><img src="http://ovbu9b92e.bkt.clouddn.com/captureComplate.jpg" alt=""><br>é…ç½®AVAssetWritterInputæœ‰ä¸¤ç§æ–¹å¼ï¼Œå»ºè®®ç”¨æ–°API</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// iOS 7</span></div><div class="line">vdo.recommendedVideoSettingsForAssetWriter(writingTo: .mov)</div><div class="line"><span class="comment">// iOS 11</span></div><div class="line">vdo.recommendedVideoSettings(forVideoCodecType: .hevc, assetWriterOutputFileType: .mov)</div></pre></td></tr></table></figure>
<h1 id="Export"><a href="#Export" class="headerlink" title="Export"></a>Export</h1><p>å¯¼å‡ºå’Œè½¬ç HEVC</p>
<ul>
<li>AVFoundationå’ŒVideoToolboxæ”¯æŒè½¬ç åˆ°HEVC</li>
<li>mp4ã€movå®¹å™¨æ ¼å¼æ”¯æŒ</li>
<li>éœ€è¦æ¡ä»¶åˆ¤æ–­çš„ä»£ç æ”¯æŒï¼ˆiPhone7+æ‰èƒ½HEVC encodeï¼‰</li>
</ul>
<p>å¯¹äºAVAssetExportSessionè‹¹æœå¼•å…¥äº†ä¸‰ä¸ªæ–°çš„Presetï¼Œå¯å°†å…¶ä»–codecæ¯”å¦‚H.264è½¬ç æˆHEVCï¼Œä»¥èŠ‚çœå­˜å‚¨ç©ºé—´</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">AVAssetExportPresetHEVC1920x1080</span></div><div class="line"><span class="type">AVAssetExportPresetHEVC3840x2160</span> </div><div class="line"><span class="type">AVAssetExportPresetHEVCHighestQuality</span></div></pre></td></tr></table></figure>
<p>AVAssetExportSessionæ˜¯æ›´é«˜å±‚çš„ç±»ï¼Œå‘ä¸‹ä¸€å±‚ç”¨AVAssetWriteræ¥åšè½¬ç çš„è¯ï¼Œç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼æ¥è®¾ç½®Preset</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Specify HEVC with output settings for AVAssetWriterInput</span></div><div class="line">settings = [<span class="type">AVVideoCodecKey</span>: <span class="type">AVVideoCodecType</span>.hevc]</div><div class="line"><span class="comment">//Convenient output settings with AVOutputSettingsAssistant</span></div><div class="line"><span class="type">AVOutputSettingsPreset</span>.hevc1920x1080 <span class="type">AVOutputSettingsPreset</span>.hevc3840x2160</div></pre></td></tr></table></figure>
<p>ä¸æ˜¯æ‰€æœ‰ç¼–ç å™¨éƒ½èƒ½é€‚é…ä½ çš„Output Settingsé€‰é¡¹ï¼Œéœ€è¦ç”¨ä¸€ä¸ªå‡½æ•°éªŒè¯ä½ çš„è¾“å‡ºæ˜¯å¦æ”¯æŒä½ è®¾ç½®çš„ç¼–ç codec,encoderIDå’Œpropertiesæ˜¯éªŒè¯åOKçš„ç¼–ç å™¨IDå’Œåˆæ³•çš„è¾“å‡ºè®¾ç½®é€‰é¡¹</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> error = <span class="type">VTCopySupportedPropertyDictionaryForEncoder</span>( <span class="number">3840</span>, <span class="number">2160</span>,</div><div class="line">kCMVideoCodecType_HEVC, encoderSpecification, &amp;encoderID, &amp;properties)</div><div class="line"><span class="keyword">if</span> error == kVTCouldNotFindVideoEncoderErr &#123; <span class="comment">// no HEVC encoder</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‘ä¸‹ä¸€å±‚æ¥çœ‹VideoToolBoxç›¸å…³çš„ç¼–ç APIï¼Œæœ€åªè¦çš„ç±»æ˜¯VTCompressionSession<br><img src="http://ovbu9b92e.bkt.clouddn.com/VideoToolBoxPreset.jpg" alt=""></p>
<h1 id="é«˜çº§ä¸»é¢˜ï¼š"><a href="#é«˜çº§ä¸»é¢˜ï¼š" class="headerlink" title="é«˜çº§ä¸»é¢˜ï¼š"></a>é«˜çº§ä¸»é¢˜ï¼š</h1><h2 id="Bit-Depth"><a href="#Bit-Depth" class="headerlink" title="Bit Depth"></a>Bit Depth</h2><p>æ—¥å‡ºæ—¥è½åœ¨ç°å®ä¸­å’Œåœ¨ç”µå½±é‡Œæ˜¯ä¸å°½ç›¸åŒçš„ï¼Œæ¯”å¦‚å·¦è¾¹çš„æ¸å˜æ˜¯ç”µå½±ä¸­æˆ‘ä»¬çœ‹åˆ°çš„æ¸å˜çš„ç»†èŠ‚ï¼Œç°è±¡çš„åŸå› æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„ç²¾åº¦å»è¡¨è¾¾è¿™ä¸ªæ¸å˜è‰²é˜¶æ¢¯é—´çš„ç»†å¾®å·®åˆ«ï¼Œè€Œ10-bitç¼–ç å¯ä»¥åšåˆ°è¿™æ ·çš„ç²¾åº¦ï¼Œè‰²å½©æ¸å˜æ›´ç»†è…»<br><img src="http://ovbu9b92e.bkt.clouddn.com/bitdepth.jpg" alt=""></p>
<p>10-bitçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ç›¸æ¯”8-bitæ›´åŠ èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œsessionæ²¡æ  <a href="http://x264.nl/x264/10bit_02-ateme-why_does_10bit_save_bandwidth.pdf" target="_blank" rel="external">http://x264.nl/x264/10bit_02-ateme-why_does_10bit_save_bandwidth.pdf</a><br>å¯¹äº8-bitå’Œ10-bit çš„æ”¯æŒå¤šè¯´ä¸€å¥ï¼Œåœ¨ iOS å¹³å°ï¼Œ 8-bitçš„ HEVC ç¡¬ç¼–ç éœ€è¦è‡³å°‘ A10 Fusion èŠ¯ç‰‡æ‰èƒ½æ”¯æŒï¼›è€ŒiOSçš„ 10-bit HEVC ç¡¬ç¼–ï¼Œç”±äºç°æœ‰iPhone CPU Levelä¸å¤Ÿï¼Œä¼°è®¡è¦ç­‰ A11 èŠ¯ç‰‡äº†ï¼ŒçŒœæµ‹ä¹Ÿè®¸10æœˆçš„iPhone 8ï¼›è€Œ 8 ä½åŠ 10 ä½ HEVC çš„è½¯ç¼–ç åˆ™æ˜¯MacOSå…¨å¹³å°æ”¯æŒã€‚HEVCçš„ç¡¬ç¼–/è½¯ç¼–çš„å¹³å°æ”¯æŒå’Œ8/10-bitçš„å¹³å°æ”¯æŒè¿™ä¸ªsessionè¯´çš„æœ‰ç‚¹ä¹±ï¼Œè¯·æ²¡çœ‹[Session 503]çš„åŒå­¦ç›´æ¥çœ‹ä¸‹é¢æ€»ç»“çš„è¡¨æ ¼ä¼šæ¸…æ™°ç‚¹ï¼š</p>
<p>HEVC Encode Support</p>
<ul>
<li>8-bit hardware encode: iOS devices with A10 Fusion chip and over | macOS devices with 6th Generation Intel Core and over</li>
<li>10-bit software encode: All Macs running macOS<br>HEVC Capture Support</li>
<li>8-bit hardware encode: iOS devices with A10 Fusion chip and over [iPhone 7 Plus, iPhone 7, 10.5-inch iPad Pro, 12.5-inch iPad Pro (2017)]</li>
</ul>
<p>HEVC Decode Support</p>
<ul>
<li>8-bit hardware decode: iOS devices with A9 chip and over | macOS devices with 6th Generation Intel Core and over</li>
<li>10-bit hardware decode: iOS devices with A9 chip and over | macOS devices with 7th Generation Intel Core</li>
<li>8-bit software decode: All iOS devices | All Macs</li>
<li>10-bit software decode: All iOS devices | All Macs</li>
</ul>
<p>é‚£ä¹ˆå¦‚ä½•è®¾ç½®10-bitå‘¢ï¼Ÿé€šè¿‡è®¾ç½®è¿™ä¸ªé€‰é¡¹kVTCompressionPropertyKey_ProfileLevel  ä¸º kVTProfileLevel_HEVC_Main10_AutoLevelï¼Œæ³¨æ„æ£€æŸ¥æ˜¯å¦æ”¯æŒ10-bit</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="type">Set</span> profile via kVTCompressionPropertyKey_ProfileLevel</div><div class="line"><span class="comment">// Check VTSessionCopySupportedPropertyDictionary() for support</span></div><div class="line">kVTProfileLevel_HEVC_Main10_AutoLevel</div><div class="line"><span class="comment">//CoreVideo pixel buffer format</span></div><div class="line">kCVPixelFormatType_420YpCbCr10BiPlanarVideoRange <span class="comment">// 10-bit 4:2:0</span></div></pre></td></tr></table></figure>
<h2 id="Hierarchical-Frame-Encoding"><a href="#Hierarchical-Frame-Encoding" class="headerlink" title="Hierarchical Frame Encoding"></a>Hierarchical Frame Encoding</h2><p><img src="http://ovbu9b92e.bkt.clouddn.com/frame101.jpg" alt=""></p>
<p>è§†é¢‘å¸§åŸºæœ¬ç±»å‹ä»‹ç»ï¼ŒIå¸§å…³é”®å¸§ï¼ŒPå‰å‘å‚è€ƒå¸§ï¼ŒBåŒå‘å‚è€ƒå¸§ï¼ŒI P Bè¶Šå¾€å³å‹ç¼©ç‡è¶Šé«˜ï¼Œè®¡ç®—å¼€é”€è¶Šå¤§ï¼Œè¿™æ–¹é¢åŸºç¡€çŸ¥è¯†ä¸€å¤§å †ï¼Œæƒ³æ·±å…¥äº†è§£çš„åŒå­¦è‡ªå·±æœæœå°±å¥½ï¼Œä¸å†èµ˜è¿°<br>ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸ªåªèƒ½è§£ç 30fpsçš„è§£ç å™¨ï¼Œä½†æœ‰ä¸ª240å¸§çš„å†…å®¹ï¼ˆæå®‰çš„æ¯”åˆ©æ—æ©ä¸­åœºæˆ˜äº‹120å¸§ã€‚ã€‚ï¼‰ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‡æƒ³çš„è§£ç å™¨å¿…é¡»ä¸¢å¸§ï¼Œä¸¢å¸§åŸåˆ™æ˜¯ä¸¢æ‰å…¶ä»–å¸§â€œä¸å‚è€ƒçš„å¸§â€ï¼Œæ¯”å¦‚IPPPPPè¿™ç§å¸§åºåˆ—å¯ä»¥ä¸¢æœ€åä¸€ä¸ªPå¸§ï¼Œæ²¡æœ‰å¸§å‚è€ƒä»–æ¥åšdiffï¼ŒåŒç†ä¹Ÿå¯ä»¥ä¸¢Bå¸§ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½ç«¯è®¾å¤‡æ’­æ”¾240fpså†…å®¹çš„çœŸå®æ¡ˆä¾‹ï¼Œæ¯éš”7ä¸ªâ€œdroppable frameâ€æœ‰ä¸€ä¸ªâ€œNon-droppable frameâ€ï¼ˆdroppable å’Œ non-droppableå¯ç†è§£æˆI/På¸§çš„æ³›åŒ–ï¼‰ï¼Œä¸ºäº†å®ç°droppable frameå¯ä¸¢ï¼Œè®©ä»–ä»¬å…¨éƒ½å‚è€ƒnon-dropable frameï¼Œè€Œä¸æ˜¯ä»–ä»¬ä¹‹é—´ç›¸äº’å‚è€ƒï¼Œä½†è¿™ä¹ˆåšå‹ç¼©ç‡æ‰ä¸‹å»äº†ï¼ŒåŸå› æ˜¯ä¸èƒ½å‚è€ƒé‚»å±…ï¼Œå¯¼è‡´æ¯ä¸ªdrappable frame diffå‡ºçš„å¤§å°å¤ªå¤§ä¸çœç©ºé—´ï¼Œ è¿™æ˜¯é—®é¢˜ä¹‹ä¸€<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame1.jpg" alt=""><br>ç”±äºå‡æƒ³çš„è§£ç å™¨åªèƒ½è§£30fpsçš„å†…å®¹ï¼Œå¼€å§‹ä¸¢å°è¯•ä¸¢å¸§ï¼Œæ¯8ä¸ªä¸¢4ä¸ªDroppableï¼Œä¸¢åˆ°120fps<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame2.jpg" alt=""><br>ç„¶åè§£ç å™¨è¯´è¿˜æ˜¯è§£ä¸äº†é‚£ä¹ˆå¤šï¼Œç»§ç»­ä¸¢åˆ°60fps<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame3.jpg" alt=""><br>No wayï¼Œç»§ç»­å‡åŠä¸¢åˆ°30fps<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame4.jpg" alt=""><br>ç„¶è€Œï¼Œè¿™æ ·çš„ç»“æ„ï¼Œæˆ‘ä»¬å¾ˆéš¾å†³ç­–æ˜¯é—´éš”çš„ä¸¢ã€è¿˜æ˜¯ä¸¢å‰ä¸€åŠæˆ–è€…åä¸€åŠã€‚<br>è§£å†³åŠæ³•æ˜¯å¼•å…¥æ—¶é—´ç­‰çº§ï¼ˆtemporal levelï¼‰ï¼Œæ–¹ä¾¿æˆ‘ä»¬å†³ç­–å“ªäº›å¸§å…ˆè¢«ä¸¢æ‰æ¯”è¾ƒåˆé€‚ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€ä¸ªlevelä¸€ä¸ªlevelçš„ä¸¢äº†ï¼Œå°±ä¸ç”¨çº ç»“æ€ä¹ˆä¸¢çš„é—®é¢˜äº†ï¼›<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame6.jpg" alt=""><br>å†æ¥çœ‹å‚è€ƒå…³ç³»ï¼Œæ˜¯ä¸æ˜¯æ›´ç´§å‡‘äº†ï¼Œä¸æ˜¯éƒ½å‚è€ƒnon-dropableäº†ï¼Œä¹Ÿä¼šå‚è€ƒé‚»å±…droppableäº†ï¼Œdiffå˜å°æé«˜äº†å‹ç¼©ç‡<br>PS: éšå«çš„æ˜¯High Levelåªå‚è€ƒ low level</p>
<p>åŒæ ·é¢å¯¹åªæ”¯æŒ30fpsçš„decoderå¼€å§‹ä¸¢å¸§ï¼Œè¿‡ç¨‹å°±å˜æˆäº†ä¸¢level<br><img src="http://ovbu9b92e.bkt.clouddn.com/frame7.jpg" alt=""><br><img src="http://ovbu9b92e.bkt.clouddn.com/frame8.jpg" alt=""><br><img src="http://ovbu9b92e.bkt.clouddn.com/frame9.jpg" alt=""></p>
<p>æ€»ç»“ä¸‹åˆ†å±‚ç¼–ç è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼š</p>
<ul>
<li>ä¼˜åŒ–äº†æ—¶é—´ä¼¸ç¼©ç­–ç•¥ï¼Œæ’­æ”¾ä¸¢å¸§æ—¶å€™ä¸å†ç”¨çŒœ</li>
<li>ä¼˜åŒ–äº†è¿åŠ¨è¡¥å¿ï¼Œä½¿å¾—å‚è€ƒå…³ç³»å˜å¾—æ›´ç´§å‡‘ï¼Œæé«˜äº†å‹ç¼©ç‡</li>
<li>è¿˜æœ‰ä¸‹é¢è¿™ä¸ªï¼Œæ²¡æŸ¥åˆ°ä»€ä¹ˆæ„æ€ï¼Œè°äº†è§£ç»™ç§‘æ™®ä¸‹ã€‚</li>
</ul>
<p>æ€ä¹ˆç”¨åˆ†å±‚ç¼–ç å‘¢ï¼Ÿè®¾ç½®ä¸¤ä¸ªå±æ€§</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Check VTSessionCopySupportedPropertyDictionary() for support kVTCompressionPropertyKey_BaseLayerFrameRate // temporal level 0 frame rate kVTCompressionPropertyKey_ExpectedFrameRate // frame rate of content</span></div></pre></td></tr></table></figure>
<p>ç»§ç»­ä¸¾ä¸Šé¢çš„ğŸŒ°ï¼Œ<br>kVTCompressionPropertyKey_BaseLayerFrameRateè®¾æˆ30ï¼ŒkVTCompressionPropertyKey_ExpectedFrameRateè®¾ç½®æˆ240,<br>BaseLayeræ˜¯å¿…é¡»è¢«è§£ç çš„å…³é”®Levelï¼Œç„¶åå…¶ä»–Levelæ˜¯ç”¨æ¥è§£ç æˆ–è€…ä¸¢å¼ƒçš„ï¼Œlevelä»é«˜åˆ°ä½çš„ä¸¢ã€‚</p>
<h2 id="HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿"><a href="#HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿" class="headerlink" title="HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿"></a>HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿</h2><h3 id="HEIFçš„å‘éŸ³"><a href="#HEIFçš„å‘éŸ³" class="headerlink" title="HEIFçš„å‘éŸ³"></a>HEIFçš„å‘éŸ³</h3><p>å¾·å›½äººğŸ‡©ğŸ‡ªè¯»Hifeï¼Œæ³•å›½ğŸ‡«ğŸ‡·è¯»Effï¼Œä¿„ç½—æ–¯ğŸ‡·ğŸ‡ºè¯»Heef,<br>ä½†è¯ºåŸºäºšçš„ç ”ç©¶äººå‘˜å¯¹è¿™ä¸ªæ ‡å‡†è´¡çŒ®æœ€å¤§ï¼Œæ‰€ä»¥ä¸ºäº†å°Šé‡ä»–ä»¬ï¼Œè¯»æˆèŠ¬å…°ğŸ‡«ğŸ‡®å£éŸ³Hafeï¼Œå°½ç®¡ä»–ä»¬æ˜¯å°‘æ•°<br><img src="http://ovbu9b92e.bkt.clouddn.com/heifpronounce.jpg" alt=""></p>
<h3 id="Why-HEIF"><a href="#Why-HEIF" class="headerlink" title="Why HEIF"></a>Why HEIF</h3><ul>
<li>ç”»è´¨ä¸€æ ·æƒ…å†µä¸‹ï¼ŒHEIFæ¯”èµ·20å¤šå²çš„JPEGå¹³å‡å°ä¸¤å€ï¼Œæ³¨æ„æ˜¯å¹³å‡ï¼Œä¸æ˜¯æœ€å¤šå°ä¸¤å€</li>
<li>HEIFå…è®¸å°†å›¾ç‰‡åˆ†æˆè‹¥å¹²åŒºå—ï¼Œè¿™å¯¹äºå¤§å›¾çš„å¢é‡å¼è§£ç å¾ˆæœ‰å¸®åŠ©çš„,è¿™é‡Œæåˆ°çš„åŒºå—(Tile)åƒä¸‡åˆ«å’Œ503ä¸­è®²çš„CTU(coding tree unit)ææ··äº†ï¼ŒTileæ˜¯å¸§å†…å¯ä»¥ç‹¬ç«‹è¿›è¡Œè§£ç çš„çŸ©å½¢åŒºåŸŸï¼ŒåŒ…å«å¤šä¸ªæŒ‰çŸ©å½¢æ’åˆ—çš„CTUï¼ˆæ•°ç›®ä¸è¦æ±‚ä¸€å®šç›¸åŒï¼‰ï¼Œå†å½¢è±¡ç‚¹ï¼ŒTileç›¸å½“äºåå®¹é“æ£‹ç›˜ï¼ŒCTUç›¸å½“äºåå®¹é“æ£‹å­ï¼Œæ£‹å­å¤§å°ä¸ä¸€å®šç›¸åŒï¼Œå®šä¹‰è¿™ä¸€ç»“æ„çš„åˆè¡·æ˜¯å¢å¼ºç¼–è§£ç çš„å¹¶è¡Œå¤„ç†æ€§èƒ½ï¼Œç±»ä¼¼é«˜å¾·åœ°å›¾æˆ–æµè§ˆå™¨åŠ è½½å¤§ç½‘é¡µçš„æ‡’åŠ è½½æŠ€æœ¯ã€‚</li>
<li>HEIFæ”¯æŒäº†é€æ˜åº¦ã€å¯¹æ¯”åº¦ã€æ·±åº¦ä¿¡æ¯ï¼Œç°ä»£å›¾åƒæ ¼å¼ä¼˜åŠ¿å°½æ˜¾<br><img src="http://ovbu9b92e.bkt.clouddn.com/heifdepthmap.jpg" alt=""><br>å¯¹äºiPhone çš„åŒæ‘„åƒå¤´å¦‚ä½•æ„ŸçŸ¥æ·±åº¦ï¼Œsessionæœªæ¶‰åŠï¼Œä½†å¤§ä½“åŸç†å…¶å®æ˜¯å¾ˆç®€å•çš„<a href="https://www.zhihu.com/question/23418797" target="_blank" rel="external">å…‰å­¦+å‡ ä½•åŸç†</a>ï¼Œä¸‹é¢ä»çŸ¥ä¹ç›—å¼ å›¾ï¼Œä¸Šè¿‡åˆä¸­çš„ä½ ä¸€å®šèƒ½çœ‹æ‡‚ï¼Œå›¾ä¸­ä¸¤ä¸ªå‡è±¡çš„æ‘„åƒå¤´è·ç¦»è¶Šè¿œæµ‹è·ç²¾åº¦è¶Šé«˜,é«˜å¤§ä¸Šçš„VRæŠ€æœ¯ä»¥æ­¤ä¸ºå‰æ<br><img src="http://ovbu9b92e.bkt.clouddn.com/zhihuceju.jpg" alt=""><br>æ·±åº¦ä¿¡æ¯å¯ä»¥è¾…åŠ©åšå¾ˆå¤šå›¾ç‰‡ç¼–è¾‘çš„æ•ˆæœï¼Œæ¯”å¦‚ä¸‹é¢çš„èƒŒæ™¯éƒ¨åˆ†åŠ äº†Noir black and white filter</li>
</ul>
<p>åŸå›¾<br><img src="http://ovbu9b92e.bkt.clouddn.com/origingirl.jpg" alt=""><br>å‰æ™¯åŠ äº†fade filterï¼Œè®²å¸ˆè¯´å°å¥³å­©çš„è£¤å­è¿˜æ˜¯ç²‰è‰²æ²¡å˜ï¼Œåƒç´ çœ¼ä»¬æ€ä¹ˆçœ‹<br><img src="http://ovbu9b92e.bkt.clouddn.com/origingirl1.jpg" alt=""><br>è¿˜å¯ä»¥è¿™æ ·ï¼Œå°å¥³å­©æ‰‹é‡Œçš„èŠ±æ™¯æ·±æœ€å°ï¼Œä¿æŒåŸæœ‰è‰²å½©ï¼Œå…¶ä»–æ·±åº¦éƒ¨åˆ†éƒ½é»‘ç™½<br><img src="http://ovbu9b92e.bkt.clouddn.com/origingirl2.jpg" alt=""><br>ä¹Ÿå¯ä»¥æ§åˆ¶å‰æ™¯èƒŒæ™¯çš„äº®åº¦ï¼Œæ¯”å¦‚ä¸‹å›¾ï¼Œè¦ä¸‹é›¨äº†ï¼Œå°å¥³å­©è¿˜åœ¨è¯¡å¼‚åœ°ç¬‘<br><img src="http://ovbu9b92e.bkt.clouddn.com/origingirl3.jpg" alt=""><br>è‹¹æœå·¥ç¨‹å¸ˆè¿˜æ˜¯å¾ˆè¯šå®çš„ï¼Œæ³¨æ„ç»†èŠ‚ï¼Œè¿™å›¾ç»å¯¹ç‰¹ä¹ˆæ²¡Pè¿‡ï¼Œç»å¯¹Demoè·‘å‡ºæ¥çš„<br><img src="http://ovbu9b92e.bkt.clouddn.com/orgingirlfoot1.jpg" alt=""><br><img src="http://ovbu9b92e.bkt.clouddn.com/orgingirlfoot2.jpg" alt=""></p>
<p>æƒ³æ·±å…¥äº†è§£HEIFçš„depth mapçš„åŒå­¦ï¼Œå¯ä»¥çœ‹507ã€508<br>HEIFä¸å…‰æ”¯æŒé™æ€å›¾ç‰‡ï¼Œä¹Ÿæ”¯æŒå›¾ç‰‡åºåˆ—ï¼Œæ¯”å¦‚è¿™ç§é•¿æ›å…‰<br><img src="http://ovbu9b92e.bkt.clouddn.com/longExpose.jpg" alt=""></p>
<p>ä¸ºäº†æ¼”ç¤ºHEIFçš„è¶…é«˜å‹ç¼©ç‡å’ŒåŒºå—æ‡’åŠ è½½ï¼ˆå‰æ–‡è§£é‡Šè¿‡çš„TileæŠ€æœ¯ï¼‰æœ‰å¤šå¹³æ»‘ï¼Œæ¼”è®²äººå±•ç¤ºäº†åœ¨è‡ªå·±iPhone7ç…§ç‰‡é‡Œæ‰¾äº†ä¸ªå…¨æ™¯å›¾ä½œä¸ºDemoï¼Œè¿™ä¸ªå…¨æ™¯å›¾æ˜¯ä¸€ä¸ª91k by 32k pixelsçš„å…¨æ™¯å›¾ï¼Œå¦‚æœç”¨RGBè‰²å½©ç©ºé—´TIFFå®¹å™¨çš„å›¾ç‰‡æ ¼å¼å­˜å‚¨è¿™ä¸ªå›¾ç‰‡æ˜¯2GBå¤§å°ï¼Œå¯¹äºHEIFåªæœ‰160MBï¼Œè€Œä¸”JPEGå¯¹å›¾ç‰‡å¤§å°é™åˆ¶åœ¨64k by 64k pixelsï¼Œç”šè‡³æ˜¯ä¸èƒ½ç”¨æ¥å­˜å‚¨è¿™å¼ å›¾çš„ï¼Œæ³¨æ„è¿™å°±æ˜¯ä½ æ¡Œé¢é‚£ä¸ªå«Yosemiteçš„ç ´çŸ³å¤´å±±ã€‚<br><img src="http://ovbu9b92e.bkt.clouddn.com/zoom1.jpg" alt=""><br>ä¸ºäº†å±•ç¤ºHEIFå¤§å°ä¸å—é™åˆ¶ï¼Œè€Œä¸”æœ‰åˆ†åŒºå—çš„å¢é‡åŠ è½½ä¸ä¼šçˆ†æ‰å†…å­˜ï¼Œæ¼”è®²è€…ä¸€è·¯æ”¾å¤§ç…§ç‰‡ï¼Œæœ€åçœ‹åˆ°äº†ç…§ç‰‡ä¸­å±±è·¯çš„é™é€Ÿæ ‡å¿—<br><img src="http://ovbu9b92e.bkt.clouddn.com/zoom2.jpg" alt=""><br>è®²çœŸï¼Œè¿™ä¸ªDemoå¤ªä¸œæ–½æ•ˆé¢¦ï¼Œå’Œ4å¹´å‰<a href="http://nokiatech.github.io/heif/comparison.html" target="_blank" rel="external">Nokia</a>å‘å¸ƒLumia 1020åœ¨è‰ä¸›é‡Œæ‰¾é’ˆçš„é‚£ä¸ªZoom in Demoå¦‚å‡ºä¸€è¾™</p>
<h3 id="Low-Level-Access-To-HEIF"><a href="#Low-Level-Access-To-HEIF" class="headerlink" title="Low Level Access To HEIF"></a>Low Level Access To HEIF</h3><p>è¯»å†™ä¸€ä¸ªå›¾ç‰‡çš„æœ€åº•å±‚çš„APIæ¥è‡ªImageIOçš„CGImageSourceå’ŒCGImageDestinationï¼Œç”¨æ³•å’Œä»¥å‰è¯»ä¸€ä¸ªJPEGä¸€æ ·ï¼Œåªæ˜¯æ¢ä¸ªæ‰©å±•åï¼Œå¦ä¸€ä¸ªåŒºåˆ«æ˜¯æ”¯æŒç¡¬è§£çš„æœºå™¨6s+ç¡®å®ä¼šè§£ç é€Ÿåº¦æ›´å¿«ä¸€äº›</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Read a jpeg image from file</span></div><div class="line"><span class="keyword">let</span> inputURL = <span class="type">URL</span>(fileURLWithPath: <span class="string">"/tmp/image.heic"</span>)</div><div class="line"><span class="keyword">let</span> source = <span class="type">CGImageSourceCreateWithURL</span>(inputURL <span class="keyword">as</span> <span class="type">CFURL</span>, <span class="literal">nil</span>)</div><div class="line"><span class="keyword">let</span> imageProperties = <span class="type">CGImageSourceCopyPropertiesAtIndex</span>(source, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>]</div><div class="line"><span class="keyword">let</span> image = <span class="type">CGImageSourceCreateImageAtIndex</span>(source, <span class="number">0</span>, <span class="literal">nil</span>)</div><div class="line"><span class="keyword">let</span> options = [kCGImageSourceCreateThumbnailFromImageIfAbsent <span class="keyword">as</span> <span class="type">String</span>: <span class="literal">true</span>, kCGImageSourceThumbnailMaxPixelSize <span class="keyword">as</span> <span class="type">String</span>: <span class="number">320</span>] <span class="keyword">as</span> [<span class="type">String</span>: <span class="type">Any</span>]</div><div class="line"><span class="keyword">let</span> thumb = <span class="type">CGImageSourceCreateThumbnailAtIndex</span>(source, <span class="number">0</span>, options <span class="keyword">as</span> <span class="type">CFDictionary</span>)</div></pre></td></tr></table></figure>
<p>ä¸Šé¢Zoom in Demoä¸­æåˆ°çš„åˆ†å—å¢é‡åŠ è½½ï¼Œå¯ä»¥ä»imagePropertiesä¸€ä¸ªå«TIFFçš„sub dictionaryæ‰¾åˆ°ç›¸å…³çš„é‡è¦å‚æ•°ï¼ŒJPEGçš„metadataæ²¡è¿™ä¸ªä¿¡æ¯ ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> imageProperties = <span class="type">CGImageSourceCopyPropertiesAtIndex</span>(source, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>]</div><div class="line"><span class="string">"&#123;TIFF&#125;"</span> = &#123;</div><div class="line">	<span class="type">DateTime</span> = <span class="string">"2017:04:01 22:50:24"</span>; <span class="type">Make</span> = <span class="type">Apple</span>;</div><div class="line">	<span class="type">Model</span> = <span class="string">"iPhone 7 Plus"</span>; <span class="type">Orientation</span> = <span class="number">1</span>;</div><div class="line">	<span class="type">ResolutionUnit</span> = <span class="number">2</span>;</div><div class="line">	<span class="type">Software</span> = <span class="string">"11.0"</span>;</div><div class="line">	<span class="type">TileLength</span> = <span class="number">512</span>;</div><div class="line">	<span class="type">TileWidth</span> = <span class="number">512</span>;</div><div class="line">	<span class="type">XResolution</span> = <span class="number">72</span>;</div><div class="line">	<span class="type">YResolution</span> = <span class="number">72</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¦‚ä½•å†™HEICå›¾ç‰‡æ–‡ä»¶ï¼ŒåŒæ ·ï¼ŒæŠŠåŸæ¥çš„jpgæ‰©å±•åæ”¹æˆheicï¼Œæ³¨æ„ç”¨guard letåšé˜²å¾¡ï¼Œä¸€æ—¦æ²¡æœ‰HEVCç¡¬ä»¶ç¼–ç å™¨ï¼Œdestination æ˜¯nil,è¿™æ˜¯å”¯ä¸€èƒ½åˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦å¯ä»¥å†™HEICçš„å‡½æ•°</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Writing a CGImage to a HEIF file</span></div><div class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(fileURLWithPath: <span class="string">"/tmp/output.heic"</span>)</div><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> destination = <span class="type">CGImageDestinationCreateWithURL</span>(url <span class="keyword">as</span> <span class="type">CFURL</span>,</div><div class="line"><span class="type">AVFileType</span>.heic <span class="keyword">as</span> <span class="type">CFString</span>, <span class="number">1</span>, <span class="literal">nil</span>)</div><div class="line"><span class="keyword">else</span> </div><div class="line">&#123;</div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"unable to create CGImageDestination"</span>)</div><div class="line">&#125;</div><div class="line"><span class="type">CGImageDestinationAddImage</span>(imageDestination, image, <span class="literal">nil</span>) <span class="type">CGImageDestinationFinalize</span>(imageDestination)</div></pre></td></tr></table></figure>
<p>HEIFä¸PhotoKit<br>Applying adjustments</p>
<ul>
<li>Photos </li>
<li>Videos</li>
<li>Live Photos</li>
</ul>
<p>Common workflows</p>
<ul>
<li>Display </li>
<li>Backup</li>
<li>Share</li>
</ul>
<h5 id="ç…§ç‰‡ç¼–è¾‘"><a href="#ç…§ç‰‡ç¼–è¾‘" class="headerlink" title="ç…§ç‰‡ç¼–è¾‘"></a>ç…§ç‰‡ç¼–è¾‘</h5><p>ç¬¬ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯æ˜¯è¯»å…¥ä¸€ä¸ªå›¾ç‰‡ã€åŠ æ—‹è½¬å’Œæ»¤é•œï¼Œè¾“å‡ºæˆé€šç”¨çš„JPEGï¼Œå¯¹äºè¯»å…¥å›¾ç‰‡æ˜¯HEIFç±»å‹ä¸ç”¨ä¿®æ”¹ä»£ç ï¼ŒPHContentEditingInputæ˜¯é€æ˜çš„</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applyPhotoFilter</span><span class="params">(<span class="number">_</span> filterName: String, input: PHContentEditingInput, output: PHContentEditingOutput, completion: <span class="params">()</span></span></span> -&gt; ()) &#123;</div><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> inputImage = <span class="type">CIImage</span>(contentsOf: input.fullSizeImageURL!) <span class="keyword">else</span> &#123; </div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"can't load input image"</span>) </div><div class="line">&#125;</div><div class="line"><span class="keyword">let</span> outputImage = inputImage .applyingOrientation(input.fullSizeImageOrientation) .applyingFilter(filterName, withInputParameters: <span class="literal">nil</span>)</div><div class="line"><span class="comment">// Write the edited image as a JPEG.</span></div><div class="line"><span class="keyword">do</span> &#123; </div><div class="line">    <span class="keyword">try</span> <span class="keyword">self</span>.ciContext.writeJPEGRepresentation(of: outputImage,</div><div class="line">to: output.renderedContentURL, colorSpace: inputImage.colorSpace!, options: [:])</div><div class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123; </div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"can't apply filter to image: <span class="subst">\(error)</span>"</span>) </div><div class="line">&#125;</div><div class="line">completion()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå…¸å‹åœºæ™¯æ˜¯è¯»å…¥ä¸€ä¸ªè§†é¢‘ï¼Œæ— è®ºè¾“å…¥æ˜¯ä¸æ˜¯HEVCï¼Œç¼–è¾‘å¹¶è¾“å‡ºæˆH.264ç¼–ç çš„é€šç”¨è§†é¢‘ï¼Œé€æ˜çš„ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Editing an HEVC video -- save as H.264</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applyVideoFilter</span><span class="params">(<span class="number">_</span> filterName: String, input: PHContentEditingInput, output: PHContentEditingOutput, completionHandler: @escaping <span class="params">()</span></span></span> -&gt; ()) &#123;</div><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> avAsset = input.audiovisualAsset <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"can't get AV asset"</span>) </div><div class="line">&#125;</div><div class="line"><span class="keyword">let</span> composition = <span class="type">AVVideoComposition</span>(asset: avAsset, applyingCIFiltersWithHandler: &#123; request <span class="keyword">in</span></div><div class="line">	<span class="keyword">let</span> img = request.sourceImage.applyingFilter(filterName, withInputParameters: <span class="literal">nil</span>) request.finish(with: img, context: <span class="literal">nil</span>)</div><div class="line">&#125;)</div><div class="line"><span class="comment">// Export the video composition to the output URL.</span></div><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> export = <span class="type">AVAssetExportSession</span>(asset: avAsset, presetName: <span class="type">AVAssetExportPresetHighestQuality</span>) <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"can't set up AV export session"</span>)</div><div class="line">&#125;</div><div class="line">export.outputFileType = <span class="type">AVFileType</span>.mov</div><div class="line">export.outputURL = output.renderedContentURL export.videoComposition = composition export.exportAsynchronously(completionHandler: completionHandler)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–è¾‘Live Photoä¸€æ ·æ˜¯æ ¼å¼é€æ˜çš„ï¼Œä¸ç®¡è¾“å…¥æ˜¯ä¸æ˜¯HEIF/HEVC,è¾“å‡ºä¼šæ˜¯JPEG/H.264å†…å®¹</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Editing a HEIF/HEVC live photo -- format handled automatically</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">applyLivePhotoFilter</span><span class="params">(<span class="number">_</span> filterName: String, input: PHContentEditingInput, output: PHContentEditingOutput, completion: @escaping <span class="params">()</span></span></span> -&gt; ()) &#123;</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> livePhotoContext = <span class="type">PHLivePhotoEditingContext</span>(livePhotoEditingInput: input) </div><div class="line"><span class="keyword">else</span> </div><div class="line">&#123;</div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"can't get live photo"</span>) </div><div class="line">&#125;</div><div class="line">livePhotoContext.frameProcessor = &#123; frame, <span class="number">_</span> <span class="keyword">in</span></div><div class="line"><span class="keyword">return</span> frame.image.applyingFilter(filterName, withInputParameters: <span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line">livePhotoContext.saveLivePhoto(to: output) &#123; success, error <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> success &#123;</div><div class="line">	completion() </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123; </div><div class="line">	<span class="built_in">print</span>(<span class="string">"can't output live photo"</span>) &#125; </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ‹æ‘„HEIFä¸»é¢˜"><a href="#æ‹æ‘„HEIFä¸»é¢˜" class="headerlink" title="æ‹æ‘„HEIFä¸»é¢˜"></a>æ‹æ‘„HEIFä¸»é¢˜</h3><p>AVCapturePhotoOutputçš„ç”¨æ³•<br><img src="http://ovbu9b92e.bkt.clouddn.com/captureheif.jpg" alt=""><br>HEIFæ‹æ‘„çš„æœºå‹é™åˆ¶ï¼šiPhone7+ å’Œ 10.5-inch iPad Pro+ï¼ˆNEWï¼‰<br><img src="http://ovbu9b92e.bkt.clouddn.com/capturedelegate.jpg" alt=""></p>
<p>ä¸Šå›¾æ˜¯AVCapturePhotoCaptureDelegateçš„å¤„ç†æµç¨‹ï¼Œè¿™ä¸ªä»£ç†èƒ½å¾ˆå¥½æ”¯æŒæ‹ç…§å„ä¸ªé˜¶æ®µ,çœ‹ä¸Šå»æ‰©å±•æ€§å¯ä»¥ï¼Œåæ¥çš„è¿­ä»£ä¸­ä¹Ÿå¢åŠ äº†didFinishRawCaptureForæ”¯æŒRAWå›¾ç‰‡æ ¼å¼ï¼Œä¹Ÿå¢åŠ äº†didFinishProcessingLivePhotoMovieç”¨æ¥æ”¯æŒæ‹æ‘„LivePhotoï¼Œä½†ç¡¬ä¼¤æ˜¯iOS4ä¹‹åä¸€ç›´ç”¨CoreMediaä¸­çš„CMSampleBufferï¼ŒCMSampleBufferå¯ä»¥ç”¨æ¥å­˜å‚¨å„ç§åª’ä½“ç±»å‹ï¼ŒåŒæ ·é€‚ç”¨äºHEVCå†…å®¹ï¼Œä½†å’ŒHEIFæ ¼å¼çš„HEVCå†…å®¹æœ‰æœ¬è´¨åŒºåˆ«ï¼Œä¸æ”¯æŒåˆ†åŒºå­˜å‚¨å¢é‡è§£ç ï¼Œè¿™æ ·çš„å†…å®¹ä¼šä»¤è§£ç å™¨è¿·æƒ‘ï¼Œæ‰€ä»¥æœ‰äº†æ–°çš„ç…§ç‰‡æ‹æ‘„ç»“æœâ€œå†…å­˜å°è£…ç±»AVCapturePhotoâ€ï¼Œç”¨æ¥ä»£æ›¿CMSampleBufferï¼Œæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æ¯”CMSampleBufferæ›´å¿«ï¼Œå¯ä»¥ä¸“é—¨ä¼˜åŒ–ä»–çš„ä¼ è¾“</li>
<li>100%ä¸å¯ä¿®æ”¹ï¼Œä¾¿äºåœ¨moduleé—´å…±äº«</li>
<li>ä¸“æœ‰æ ¼å¼æ”¯æŒ</li>
</ol>
<p>AVCapturePhotoçš„æ ¼å¼ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">open <span class="class"><span class="keyword">class</span> <span class="title">AVCapturePhoto</span> : <span class="title">NSObject</span> </span>&#123;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> timestamp: <span class="type">CMTime</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> isRawPhoto: <span class="type">Bool</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> pixelBuffer: <span class="type">CVPixelBuffer</span>? &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> previewPixelBuffer: <span class="type">CVPixelBuffer</span>? &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> embeddedThumbnailPhotoFormat: [<span class="type">String</span> : <span class="type">Any</span>]? &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> metadata: [<span class="type">String</span> : <span class="type">Any</span>] &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> depthData: <span class="type">AVDepthData</span>? &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> resolvedSettings: <span class="type">AVCaptureResolvedPhotoSettings</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> photoCount: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> bracketSettings: <span class="type">AVCaptureBracketedStillImageSettings</span>? &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> sequenceCount: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="keyword">var</span> lensStabilizationStatus: <span class="type">AVCaptureDevice</span>.<span class="type">LensStabilizationStatus</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    open <span class="function"><span class="keyword">func</span> <span class="title">fileDataRepresentation</span><span class="params">()</span></span> -&gt; <span class="type">Data</span>?</div><div class="line"></div><div class="line">    open <span class="function"><span class="keyword">func</span> <span class="title">cgImageRepresentation</span><span class="params">()</span></span> -&gt; <span class="type">Unmanaged</span>&lt;<span class="type">CGImage</span>&gt;?</div><div class="line"></div><div class="line">    open <span class="function"><span class="keyword">func</span> <span class="title">previewCGImageRepresentation</span><span class="params">()</span></span> -&gt; <span class="type">Unmanaged</span>&lt;<span class="type">CGImage</span>&gt;?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å»ºè®®é€æ¸åºŸå¼ƒä¹‹å‰AVCapturePhotoCaptureDelegateçš„è€æ–¹æ³•ï¼Œæœªæ¥ä¼šDeprecate</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">photoOutput</span><span class="params">(<span class="number">_</span> output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto,</span></span></div><div class="line">error: Error?)</div></pre></td></tr></table></figure>
<p>ç”¨ä»¥å¾€çš„æ–¹å¼å­˜ä¸€ä¸ªå›¾ç‰‡ï¼Œæ„å‘³ç€è¦å¤§é‡æ“ä½œthumbnailå’Œmetadataï¼Œä¼šä¼´éšå¾ˆå¤šå›¾ç‰‡Scaleå’Œå‹ç¼©æ“ä½œï¼Œæ€§èƒ½ä¸Šä¸æ˜¯æœ€ä¼˜çš„ã€‚<br><img src="http://ovbu9b92e.bkt.clouddn.com/oldwaysave.jpg" alt=""><br>æ–°APIçš„å¤„ç†æ–¹å¼æ˜¯è®©ä½ å……åˆ†å®šåˆ¶å®¹å™¨å±æ€§ï¼Œæ¯”å¦‚å¯ä»¥åœ¨AVCapturePhotoSettingsæŒ‡å®šcodecã€æ–‡ä»¶ç±»å‹ï¼Œmetadataé‡ŒæŒ‡å®šåœ°ç‚¹ï¼ŒæŒ‡å®šç¼©ç•¥å›¾çš„åˆ†è¾¨ç‡ï¼Œè¯·æ±‚ådelegate è¿”å›çš„AVCapturePhotoå·²ç»è¢«åµŒå…¥åˆ°HEICå®¹å™¨ï¼Œä¹ŸåŒ…å«äº†ä½ è¦çš„é‚£ä¸ªç¼©ç•¥å›¾ï¼Œæœ€åè°ƒç”¨photo.fileDataRepresentation()çš„å¤„ç†ç›¸æ¯”old wayå°±ç®€å•å¤šäº†ï¼Œçº¯NSDataåˆ°å­˜å‚¨çš„å­—èŠ‚copyï¼Œæ²¡æœ‰å¤šä½™çš„å‹ç¼©ã€ç¼©æ”¾æ“ä½œï¼Œå°¤å…¶å­˜HEIFå›¾ä¼šå……åˆ†é‡Šæ”¾æ€§èƒ½ä¼˜åŠ¿<br><img src="http://ovbu9b92e.bkt.clouddn.com/newwaysave.jpg" alt=""></p>
<h3 id="HEVCæ€§èƒ½é¡»çŸ¥ï¼š"><a href="#HEVCæ€§èƒ½é¡»çŸ¥ï¼š" class="headerlink" title="HEVCæ€§èƒ½é¡»çŸ¥ï¼š"></a>HEVCæ€§èƒ½é¡»çŸ¥ï¼š</h3><p>1.å¦‚æœä¸€è¾¹åœ¨å½•åˆ¶HEVCè§†é¢‘ä¸€è¾¹åœ¨æ‹HEICç…§ç‰‡çš„è¯ï¼ˆè¿™ä¾‹å­æ„Ÿè§‰æœ‰ç‚¹æç«¯å•Šï¼Œæ¯”å¦‚ä¸€ä¸ªç›´æ’­æ¨H.265ï¼Œä¸€è¾¹åœ¨æ‹ç…§ã€‚ã€‚WTFï¼‰ï¼ŒHEVCç¡¬ä»¶ç¼–ç å™¨ä¼šå¾ˆå¿™ï¼Œå¦‚æœä½ æ‹çš„æ˜¯4K 60fpsè§†é¢‘ï¼Œç¼–ç å™¨ä¼šå¿™å‡ºç¿”ï¼Œä»–åªèƒ½ä¼˜å…ˆå¤„ç†å¯¹å®æ—¶æ€§æœ‰æ›´é«˜è¦æ±‚çš„è§†é¢‘æ‹æ‘„ï¼Œä½ çš„æ‹ç…§Requestä¼šæ»åï¼›ä¸”ä¸ºäº†ä¿è¯ä½ æ‹æ‘„é«˜æ¸…è§†é¢‘çš„å¸§ç‡deadlineï¼Œåœ¨ä½ è¯·æ±‚æ‹ç…§æ—¶åªèƒ½åˆ†å‡ºå¾ˆå°‘çš„æ—¶é—´ç‰‡æ¥å¤„ç†ä½ çš„è¯·æ±‚ï¼ŒHEIFçš„é«˜å‹ç¼©ç‡æ˜¯æœ‰æ—¶é—´æˆæœ¬çš„ï¼Œè¿™æ—¶å€™éœ€è¦ç©ºé—´æ¢æ—¶é—´ï¼ŒTrade offæ‰20%çš„å‹ç¼©ç‡ï¼Œæ¢å°½å¿«callbackä½ è¦çš„ç…§ç‰‡ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªæç«¯åœºæ™¯çš„é—®é¢˜ï¼Ÿå¯ä»¥åœ¨æ‹ç…§é‡Œè®¾ç½®ç”¨JPEGï¼ŒHEVCç¼–ç å™¨å°±æ¸…å‡€äº†ã€‚<br>2.è¿˜æœ‰ä¸ªæç«¯åœºæ™¯æ˜¯é•¿æ›å…‰ï¼Œé•¿æ›å…‰è¾“å‡ºçš„ä¸æ˜¯Videoï¼Œæ˜¯åºåˆ—å¸§å›¾ç‰‡ï¼Œè€Œä¸”æœ‰æ¯ç§’10å¸§çš„åŸºçº¿è¦æ±‚ï¼Œå¯¹ç¼–ç å™¨å¤„ç†æ•ˆç‡è¦æ±‚å¾ˆé«˜çš„ï¼ŒHEIFæ ¼å¼å‹‰å¼ºå¯ä»¥cover 10fpsçš„åºåˆ—å¸§ï¼ˆåºåˆ—å¸§ä¸­å›¾åƒåº”è¯¥æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ— å¸§é—´é¢„æµ‹ï¼Œä»–çš„10fpså¯ä»¥ç†è§£æˆæ¯ç§’10ä¸ªå…³é”®å¸§ï¼‰ï¼Œä½†å¸§ç‡è¦æ±‚æ›´é«˜çš„è¯å°±åˆ‡å›JPEGå§ã€‚</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/HEVC/" rel="tag"># HEVC</a>
          
            <a href="/tags/H-265/" rel="tag"># H.265</a>
          
            <a href="/tags/HEIF/" rel="tag"># HEIF</a>
          
            <a href="/tags/WWDC/" rel="tag"># WWDC</a>
          
            <a href="/tags/2017/" rel="tag"># 2017</a>
          
            <a href="/tags/ç¼–ç åŸç†/" rel="tag"># ç¼–ç åŸç†</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/27/wwdc-2017-Session-503-Introducing-HEIF-and-HEVC/" rel="next" title="WWDC 2017 Session 503 Introducing HEIF and HEVC">
                <i class="fa fa-chevron-left"></i> WWDC 2017 Session 503 Introducing HEIF and HEVC
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/20/ã€ŠåŸåˆ™ã€‹è¯»ä¹¦ç¬”è®°/" rel="prev" title="ã€ŠåŸåˆ™ã€‹è¯»ä¹¦ç¬”è®°">
                ã€ŠåŸåˆ™ã€‹è¯»ä¹¦ç¬”è®° <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/avatar/avatar.png"
                alt="è°·é›¨" />
            
              <p class="site-author-name" itemprop="name">è°·é›¨</p>
              <p class="site-description motion-element" itemprop="description">â€œLive well, Laugh often, Love much.â€</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å‰æƒ…æè¦"><span class="nav-number">1.</span> <span class="nav-text">å‰æƒ…æè¦</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Access"><span class="nav-number">2.</span> <span class="nav-text">Access</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Playback"><span class="nav-number">3.</span> <span class="nav-text">Playback</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Capture"><span class="nav-number">4.</span> <span class="nav-text">Capture</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Export"><span class="nav-number">5.</span> <span class="nav-text">Export</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#é«˜çº§ä¸»é¢˜ï¼š"><span class="nav-number">6.</span> <span class="nav-text">é«˜çº§ä¸»é¢˜ï¼š</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bit-Depth"><span class="nav-number">6.1.</span> <span class="nav-text">Bit Depth</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hierarchical-Frame-Encoding"><span class="nav-number">6.2.</span> <span class="nav-text">Hierarchical Frame Encoding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿"><span class="nav-number">6.3.</span> <span class="nav-text">HEIFçš„æ­£ç¡®æ‰“å¼€å§¿åŠ¿</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HEIFçš„å‘éŸ³"><span class="nav-number">6.3.1.</span> <span class="nav-text">HEIFçš„å‘éŸ³</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why-HEIF"><span class="nav-number">6.3.2.</span> <span class="nav-text">Why HEIF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Low-Level-Access-To-HEIF"><span class="nav-number">6.3.3.</span> <span class="nav-text">Low Level Access To HEIF</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ç…§ç‰‡ç¼–è¾‘"><span class="nav-number">6.3.3.0.1.</span> <span class="nav-text">ç…§ç‰‡ç¼–è¾‘</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹æ‘„HEIFä¸»é¢˜"><span class="nav-number">6.3.4.</span> <span class="nav-text">æ‹æ‘„HEIFä¸»é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HEVCæ€§èƒ½é¡»çŸ¥ï¼š"><span class="nav-number">6.3.5.</span> <span class="nav-text">HEVCæ€§èƒ½é¡»çŸ¥ï¼š</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">è°·é›¨</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
